#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Run lint and prettier on all staged and edited files

# Get all staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx|json|css|md|html)$' || true)

# Get all edited (unstaged) files
EDITED_FILES=$(git diff --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx|json|css|md|html)$' || true)

# Combine and deduplicate
ALL_FILES=$(echo "$STAGED_FILES\n$EDITED_FILES" | sort | uniq)

if [ -z "$ALL_FILES" ]; then
  exit 0
fi

# Run prettier --write on all files
npx prettier --write $ALL_FILES

# Add any files that were changed by prettier
for file in $ALL_FILES; do
  git add "$file"
done

# Run lint on all files
npx next lint --fix --file $ALL_FILES

# Add any files that were fixed by lint
for file in $ALL_FILES; do
  git add "$file"
done
